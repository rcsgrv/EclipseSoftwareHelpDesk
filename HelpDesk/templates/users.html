{% extends "base.html" %}
{% block title %}Users{% endblock %}

{% block content %}
<div class="container my-4">

    <form method="POST" action="{{ url_for('users.update_admin') }}" id="users-form">

        <!-- External Users Table -->
        <div class="card shadow-sm mb-4">
            <div class="card-header text-white" style="background-color: #4C6C85;">
                <h5 class="mb-0">External Users</h5>
            </div>
            <div class="card-body">
                {% if non_administrator_data %}
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0">
                        <thead class="custom-table-header text-center">
                            <tr>
                                <th>Forename</th>
                                <th>Surname</th>
                                <th>Reported Issues</th>
                                <th>Admin?</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in non_administrator_data %}
                            <tr>
                                <td class="text-center">{{ u.forename }}</td>
                                <td class="text-center">{{ u.surname }}</td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ u.ticket_count }}</span>
                                </td>
                                <td class="text-center">
                                    <input type="hidden" name="user_ids" value="{{ u.id }}">
                                    <input type="checkbox" name="is_admin_{{ u.id }}" {% if u.is_admin %}checked{% endif %}>
                                </td>
                                <td class="text-center">
                                    <form method="POST" action="{{ url_for('users.delete_user', user_id=u.id) }}" class="d-inline"
                                          onsubmit="return confirm('Are you sure you want to delete this user?');">
                                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center mb-0">No external users found.</p>
                {% endif %}
            </div>
        </div>

        <!-- Eclipse Staff Table -->
        <div class="card shadow-sm mb-4">
            <div class="card-header text-white" style="background-color: #4C6C85;">
                <h5 class="mb-0">Eclipse Staff</h5>
            </div>
            <div class="card-body">
                {% if administrator_data %}
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0">
                        <thead class="custom-table-header text-center">
                            <tr>
                                <th>Forename</th>
                                <th>Surname</th>
                                <th>Assigned Issues</th>
                                <th>Admin?</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in administrator_data %}
                            <tr>
                                <td class="text-center">{{ u.forename }}</td>
                                <td class="text-center">{{ u.surname }}</td>
                                <td class="text-center"><span class="badge bg-primary">{{ u.ticket_count }}</span></td>
                                <td class="text-center">
                                    {% if u.id != current_user.id %}
                                        <input type="hidden" name="user_ids" value="{{ u.id }}">
                                        <input type="checkbox" name="is_admin_{{ u.id }}" {% if u.is_admin %}checked{% endif %}>
                                    {% else %}
                                        <!-- Disable the checkbox for the current user to prevent them from altering their own admin status                                   -->
                                        <input type="hidden" name="user_ids" value="{{ u.id }}">
                                        <input type="checkbox" name="is_admin{{ u.id }}" {% if u.is_admin %}checked{% endif %} disabled>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if u.id != current_user.id %}
                                    <form method="POST" action="{{ url_for('users.delete_user', user_id=u.id) }}" class="d-inline"
                                          onsubmit="return confirm('Are you sure you want to delete this user?');">
                                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                    {% else %}
                                    <span>N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center mb-0">No Eclipse Staff found.</p>
                {% endif %}
            </div>
        </div>

        <div class="text-end mt-3" id="save-users-btn" style="display:none;">
            <button type="submit" class="btn btn-primary"
                    onclick="return confirm('Are you sure you want to update the admin status for the selected user(s)?');">
                Save
            </button>
        </div>
    </form>
</div>

<!-- This script will show the save button below the Eclipse Staff table when a checkboxes state is altered (i.e. true or false) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('save-users-btn');
    // This Get all checkboxes inside the form
    const checkboxes = document.querySelectorAll('#users-form input[type="checkbox"]');

    // This stores the original state of the checkbox in a data attribute
    checkboxes.forEach(cb => {
        cb.dataset.original = cb.checked ? 'true' : 'false';
    });

    function checkForChanges() {
        let changed = false;
        checkboxes.forEach(cb => {
            if (cb.name && cb.checked.toString() !== cb.dataset.original) {
                changed = true;
            }
        });
        saveBtn.style.display = changed ? 'block' : 'none';
    }

    checkboxes.forEach(cb => cb.addEventListener('change', checkForChanges));

    checkForChanges();
});
</script>
{% endblock %}
